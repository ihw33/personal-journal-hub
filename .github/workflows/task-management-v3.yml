name: Task Management Automation v3

on:
  issues:
    types: [opened, closed, edited, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

jobs:
  update-notion:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[ì—…ë¬´ë¶„ë‹´]')
    
    steps:
    - name: Update Notion Database
      uses: actions/github-script@v7
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        # UUID í˜•ì‹ìœ¼ë¡œ ì •í™•í•œ ID ì‚¬ìš©
        NOTION_DATABASE_ID: "24b3b64b-a468-80cd-b71a-ee36f01a1573"
      with:
        script: |
          const issue = context.payload.issue;
          const action = context.payload.action;
          
          console.log(`Processing issue: ${issue.title}`);
          console.log(`Database ID: ${process.env.NOTION_DATABASE_ID}`);
          
          // CLI ì´ë¦„ ì¶”ì¶œ
          const cliMatch = issue.title.match(/(Gemini CLI|Codex CLI|Claude Code)/);
          const cli = cliMatch ? cliMatch[1] : 'Unknown CLI';
          
          // ìƒíƒœ ê²°ì •
          let status = 'pending';
          if (action === 'closed') {
            status = 'completed';
          } else if (issue.assignees && issue.assignees.length > 0) {
            status = 'in_progress';
          }
          
          // Notion ì—…ë°ì´íŠ¸
          try {
            const https = require('https');
            
            const postData = JSON.stringify({
              parent: { 
                database_id: process.env.NOTION_DATABASE_ID 
              },
              properties: {
                'Task': {
                  title: [{ 
                    text: { 
                      content: issue.title.replace('[ì—…ë¬´ë¶„ë‹´] ', '') 
                    } 
                  }]
                },
                'CLI': {
                  select: { name: cli }
                },
                'Status': {
                  select: { name: status }
                },
                'Timestamp': {
                  date: { 
                    start: new Date().toISOString() 
                  }
                },
                'GitHub Issue': {
                  url: issue.html_url
                }
              }
            });
            
            const options = {
              hostname: 'api.notion.com',
              path: '/v1/pages',
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.NOTION_TOKEN}`,
                'Content-Type': 'application/json',
                'Notion-Version': '2022-06-28',
                'Content-Length': Buffer.byteLength(postData)
              }
            };
            
            const req = https.request(options, (res) => {
              let data = '';
              
              res.on('data', (chunk) => {
                data += chunk;
              });
              
              res.on('end', () => {
                if (res.statusCode === 200) {
                  console.log('âœ… Successfully updated Notion database!');
                  const result = JSON.parse(data);
                  console.log('Created page ID:', result.id);
                } else {
                  console.error('âŒ Notion API error:', data);
                }
              });
            });
            
            req.on('error', (e) => {
              console.error('âŒ Request error:', e.message);
            });
            
            req.write(postData);
            req.end();
            
          } catch (error) {
            console.error('âŒ Error updating Notion:', error.message);
          }

  notify-assignment:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && contains(github.event.issue.title, '[ì—…ë¬´ë¶„ë‹´]')
    
    steps:
    - name: Post Assignment Comment
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          
          const comment = 'ğŸ¯ **ìƒˆ ì—…ë¬´ê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤!**\\n\\n' +
            'ì—…ë¬´ë¥¼ í™•ì¸í•˜ê³  ì§„í–‰í•´ì£¼ì„¸ìš”. ì™„ë£Œ í›„ ì´ Issueì— ëŒ“ê¸€ë¡œ ë³´ê³ í•´ì£¼ì‹œë©´ ìë™ìœ¼ë¡œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.\\n\\n' +
            '### ğŸ“‹ ë¹ ë¥¸ í™•ì¸\\n' +
            '- Notion ë°ì´í„°ë² ì´ìŠ¤ì— ìë™ ê¸°ë¡ë¨\\n' +
            '- ë„ì›€ í•„ìš”ì‹œ: ì´ Issueì— ëŒ“ê¸€ ì‘ì„±\\n\\n' +
            '---\\n' +
            '*ğŸ¤– ìë™ ì•Œë¦¼: Task Management System v3*';
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });