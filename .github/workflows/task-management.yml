name: Task Management Automation

on:
  issues:
    types: [opened, closed, edited, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

jobs:
  update-task-logs:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[ì—…ë¬´ë¶„ë‹´]') || contains(github.event.comment.body, 'ì™„ë£Œ')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm install @octokit/rest
        
    - name: Update Task Status
      uses: actions/github-script@v7
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      with:
        script: |
          const { Octokit } = require('@octokit/rest');
          const octokit = new Octokit({
            auth: context.payload.installation.access_tokens_url ? undefined : process.env.GITHUB_TOKEN
          });
          
          // Issue ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const issue = context.payload.issue;
          const action = context.payload.action;
          
          console.log(`Processing issue: ${issue.title}`);
          console.log(`Action: ${action}`);
          
          // ì—…ë¬´ë¶„ë‹´ Issueì¸ì§€ í™•ì¸
          if (!issue.title.includes('[ì—…ë¬´ë¶„ë‹´]')) {
            console.log('Not a task assignment issue, skipping');
            return;
          }
          
          // CLI ì´ë¦„ ì¶”ì¶œ
          const cliMatch = issue.title.match(/(Gemini CLI|Codex CLI|Claude Code)/);
          const cli = cliMatch ? cliMatch[1] : 'Unknown CLI';
          
          // ìƒíƒœ ê²°ì •
          let status = 'pending';
          if (action === 'closed') {
            status = 'completed';
          } else if (issue.assignees && issue.assignees.length > 0) {
            status = 'in_progress';
          }
          
          // ë¡œê·¸ ì—…ë°ì´íŠ¸ ë‚´ìš© ìƒì„±
          const logEntry = {
            timestamp: new Date().toISOString(),
            cli: cli,
            task: issue.title.replace('[ì—…ë¬´ë¶„ë‹´] ', ''),
            status: status,
            issue_url: issue.html_url,
            action: action
          };
          
          console.log('Log entry:', JSON.stringify(logEntry, null, 2));
          
          // GitHubì— íŒŒì¼ ì—…ë°ì´íŠ¸ (CLI_STATUS_DASHBOARD.md)
          try {
            const { data: fileData } = await octokit.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'CLI_STATUS_DASHBOARD.md'
            });
            
            let content = Buffer.from(fileData.content, 'base64').toString();
            
            // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
            const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            content = content.replace(
              /## â° \*\*ì§€ê¸ˆ ì´ ìˆœê°„\*\* \([^)]+\)/,
              `## â° **ì§€ê¸ˆ ì´ ìˆœê°„** (${now})`
            );
            
            // CLIë³„ ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
            const statusEmoji = status === 'completed' ? '[ì™„ë£Œ]' : status === 'in_progress' ? '[ì§„í–‰ì¤‘]' : '[ëŒ€ê¸°ì¤‘]';
            const taskLine = `${cli}: ${statusEmoji} ${logEntry.task}`;
            
            // ê¸°ì¡´ CLI ë¼ì¸ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
            const cliPattern = new RegExp(`${cli}: \\[[^\\]]+\\] [^\\n]+`, 'g');
            if (content.match(cliPattern)) {
              content = content.replace(cliPattern, taskLine);
            } else {
              // ìƒˆ CLI ë¼ì¸ ì¶”ê°€
              content = content.replace(
                /```\n([^`]*)\n```/,
                `\`\`\`\n$1\n${taskLine}\n\`\`\``
              );
            }
            
            // íŒŒì¼ ì—…ë°ì´íŠ¸
            await octokit.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'CLI_STATUS_DASHBOARD.md',
              message: `ğŸ¤– Task status updated: ${cli} - ${logEntry.task}`,
              content: Buffer.from(content).toString('base64'),
              sha: fileData.sha
            });
            
            console.log('Successfully updated CLI_STATUS_DASHBOARD.md');
            
          } catch (error) {
            console.error('Error updating dashboard:', error);
          }
          
          // Notion ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­ - í† í°ì´ ìˆëŠ” ê²½ìš°ë§Œ)
          if (process.env.NOTION_TOKEN) {
            try {
              const notion = require('@notionhq/client');
              const notionClient = new notion.Client({
                auth: process.env.NOTION_TOKEN
              });
              
              // Notion ë°ì´í„°ë² ì´ìŠ¤ì— ì‘ì—… ë¡œê·¸ ì¶”ê°€
              await notionClient.pages.create({
                parent: { database_id: process.env.NOTION_DATABASE_ID },
                properties: {
                  'Task': {
                    title: [{ text: { content: logEntry.task } }]
                  },
                  'CLI': {
                    select: { name: cli }
                  },
                  'Status': {
                    select: { name: status }
                  },
                  'Timestamp': {
                    date: { start: logEntry.timestamp }
                  },
                  'GitHub Issue': {
                    url: issue.html_url
                  }
                }
              });
              
              console.log('Successfully updated Notion database');
              
            } catch (notionError) {
              console.error('Error updating Notion:', notionError);
            }
          }

  notify-task-assignment:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && contains(github.event.issue.title, '[ì—…ë¬´ë¶„ë‹´]')
    
    steps:
    - name: Notify CLI Assignment
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          
          // CLIë³„ ë©˜ì…˜ ì„¤ì • (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const mentions = {
            'Gemini CLI': '@gemini-cli-user',
            'Codex CLI': '@codex-cli-user',
            'Claude Code': '@ihw33'
          };
          
          // ë‹´ë‹¹ì ì¶”ì¶œ ë° ë©˜ì…˜
          const title = issue.title;
          let mentionList = [];
          
          Object.entries(mentions).forEach(([cli, mention]) => {
            if (title.includes(cli)) {
              mentionList.push(mention);
            }
          });
          
          const comment = `ğŸ¯ **ìƒˆ ì—…ë¬´ê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤!**
          
${mentionList.join(' ')} 
          
ìœ„ ì—…ë¬´ë¥¼ í™•ì¸í•˜ê³  ì§„í–‰í•´ì£¼ì„¸ìš”. ì™„ë£Œ í›„ ì´ Issueì— ëŒ“ê¸€ë¡œ ë³´ê³ í•´ì£¼ì‹œë©´ ìë™ìœ¼ë¡œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.

### ğŸ“‹ ë¹ ë¥¸ í™•ì¸
- í˜„ì¬ ìƒíƒœ: CLI_STATUS_DASHBOARD.md
- ì „ì²´ ë¡œê·¸: INTEGRATED_WORK_LOG.md
- ë„ì›€ í•„ìš”ì‹œ: ì´ Issueì— ëŒ“ê¸€ ì‘ì„±

---
*ğŸ¤– ìë™ ì•Œë¦¼: Task Management System*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });